# 第 8阶段课程笔记

## 50-51 | 案例篇：动态追踪怎么用？（上下）

**动态追踪技术，通过探针机制，来采集内核或者应用程序的运行信息，从而可以不用修改内核和应用程序的代码，就获得丰富的信息，帮你分析、定位想要排查的问题。**



动态追踪漫谈：

<https://blog.openresty.com.cn/cn/dynamic-tracing/>

### 动态追踪的事件源

根据事件类型的不同，动态追踪所使用的事件源，可以分为静态探针、动态探针以及硬件事件等三类。

1. 硬件事件通常由性能监控计数器 PMC（Performance Monitoring Counter）产生，包括了各种硬件的性能情况，比如 CPU 的缓存、指令周期、分支预测等等。
2. 静态探针，是指事先在代码中定义好，并编译到应用程序或者内核中的探针。常见的静态探针包括内核中的跟踪点（tracepoints）和 USDT（Userland Statically Defined Tracing）探针。
3. 动态探针，则是指没有事先在代码中定义，但却可以在运行时动态添加的探针，比如函数的调用和返回等。常见的动态探针有两种，即用于内核态的 kprobes 和用于用户态的 uprobes。



### 动态追踪机制

在 Linux 系统中，常见的动态追踪方法包括 ftrace、perf、eBPF 以及 SystemTap 等。

#### ftrace

<https://zhuanlan.zhihu.com/p/33267453>

<https://www.ibm.com/developerworks/cn/linux/l-cn-ftrace/index.html>



#### perf

perf 可以用来分析 CPU cache、CPU 迁移、分支预测、指令周期等各种硬件事件；

perf 也可以只对感兴趣的事件进行动态追踪。



**strace 的重大缺陷：**

由于 ptrace 是系统调用，就需要在内核态和用户态切换。当事件数量比较多时，繁忙的切换必然会影响原有服务的性能；

ptrace 需要借助 SIGSTOP 信号挂起目标进程。这种信号控制和进程挂起，会影响目标进程的行为。



#### eBPF 和 BCC



很多 eBPF 的新特性，都需要比较新的内核版本支持。



<https://www.tuicool.com/articles/veuIrai>



#### SystemTap 和 sysdig

SystemTap 也是一种可以通过脚本进行自由扩展的动态追踪技术。在 eBPF 出现之前，SystemTap 是 Linux 系统中，功能最接近 DTrace 的动态追踪机制。

从稳定性上来说，SystemTap 只在 RHEL 系统中好用，在其他系统中则容易出现各种异常问题。



#### 如何选择追踪工具

在 Linux 系统中，常见的动态追踪方法，包括 ftrace、perf、eBPF 以及 SystemTap 等。

在大多数性能问题中，使用 perf 配合火焰图是一个不错的方法。

如果这满足不了你的要求，那么：在新版的内核中，eBPF 和 BCC 是最灵活的动态追踪方法；而在旧版本内核中，特别是在 RHEL 系统中，由于 eBPF 支持受限，SystemTap 往往是更好的选择。



![选择跟踪工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-01.png)



## 52 | 案例篇：服务吞吐量下降很厉害，怎么分析？

从这个案例你也可以看出，性能问题的分析，总是离不开系统和应用程序的原理。

**实际上，分析性能瓶颈，最核心的也正是掌握运用这些原理。**

首先，利用各种性能工具，收集想要的性能指标，从而清楚系统和应用程序的运行状态；

其次，拿目前状态跟系统原理进行比较，不一致的地方，就是我们要重点分析的对象。

从这个角度出发，再进一步借助 perf、火焰图、bcc 等动态追踪工具，找出热点函数，就可以定位瓶颈的来源，确定相应的优化方法。



## 53 | 套路篇：系统监控的综合思路

### USE 法

USE 法把系统资源的性能指标，简化成了三个类别，即使用率、饱和度以及错误数。

![常用指标USE法](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-02.png)



### 监控系统

掌握 USE 方法以及需要监控的性能指标后，接下来要做的，就是建立监控系统，把这些指标保存下来；然后，根据这些监控到的状态，自动分析和定位大致的瓶颈来源；最后，再通过告警系统，把问题及时汇报给相关团队处理。

一个完整的监控系统通常由数据采集、数据存储、数据查询和处理、告警以及可视化展示等多个模块组成。



## 54 | 套路篇：应用监控的一般思路

### 指标监控

应用程序的核心指标，不再是资源的使用情况，而是请求数、错误率和响应时间。

第一个，是应用进程的资源使用情况。

第二个，是应用程序之间调用情况。

第三个，是应用程序内部核心逻辑的运行情况。

### 日志监控

对日志监控来说，最经典的方法，就是使用 ELK 技术栈，即使用 Elasticsearch、Logstash 和 Kibana 这三个组件的组合。



## 55 | 套路篇：分析性能问题的一般步骤

### 系统资源瓶颈

#### CPU 性能分析

![CPU性能分析](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/02-03.png)

#### 内存性能分析

![内存性能分析](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/03-06.png)

#### 磁盘和文件系统 I/O 性能分析

![磁盘IO性能分析](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/05-04.png)

#### 网络性能分析

在链路层，可以从网络接口的吞吐量、丢包、错误以及软中断和网络功能卸载等角度分析；

在网络层，可以从路由、分片、叠加网络等角度进行分析；

在传输层，可以从 TCP、UDP 的协议原理出发，从连接数、吞吐量、延迟、重传等角度进行分析；

在应用层，可以从应用层协议（如 HTTP 和 DNS）、请求数（QPS）、套接字缓存等角度进行分析。

### 应用程序瓶颈

就其本质来源，实际上只有三种，**也就是资源瓶颈、依赖服务瓶颈以及应用自身的瓶颈**。

第一种资源瓶颈，其实还是指刚才提到的 CPU、内存、磁盘和文件系统 I/O、网络以及内核资源等各类软硬件资源出现了瓶颈，从而导致应用程序的运行受限。对于这种情况，我们就可以用前面系统资源瓶颈模块提到的各种方法来分析。

第二种依赖服务的瓶颈，也就是诸如数据库、分布式缓存、中间件等应用程序，直接或者间接调用的服务出现了性能问题，从而导致应用程序的响应变慢，或者错误率升高。这说白了就是跨应用的性能问题，使用全链路跟踪系统，就可以帮你快速定位这类问题的根源。

最后一种，应用程序自身的性能问题，包括了多线程处理不当、死锁、业务算法的复杂度过高等等。对于这类问题，在我们前面讲过的应用程序指标监控以及日志监控中，观察关键环节的耗时和内部执行过程中的错误，就可以帮你缩小问题的范围。

可以用系统资源模块提到的各类进程分析工具，来进行分析定位。比如：

**可以用 strace，观察系统调用；**

**使用 perf 和火焰图，分析热点函数；**

**甚至使用动态追踪技术，来分析进程的执行状态。**



## 56 | 套路篇：优化性能问题的一般方法

基本是之前的总结，这里省略。



从系统的角度来说，CPU、内存、磁盘和文件系统 I/O、网络以及内核数据结构等各类软硬件资源，为应用程序提供了运行的环境，也是我们性能优化的重点对象。

从应用程序的角度来说，降低 CPU 使用，减少数据访问和网络 I/O，使用缓存、异步处理以及多进程多线程等，都是常用的性能优化方法。

一定要避免过早优化。性能优化往往会提高复杂性，这一方面降低了可维护性，另一方面也为适应复杂多变的新需求带来障碍。

所以，性能优化最好是逐步完善，动态进行；不追求一步到位，而要首先保证，能满足当前的性能要求。发现性能不满足要求或者出现性能瓶颈后，再根据性能分析的结果，选择最重要的性能问题进行优化。



## 57 | 套路篇：Linux 性能工具速查

### CPU 性能工具

![CPU性能指标](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-03.png)

![CPU性能工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-04.png)



### 内存 性能工具

![内存性能指标](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-05.png)

![内存性能工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-06.png)

### 磁盘IO性能工具

![IO性能指标](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-07.png)

![IO性能工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-08.png)

### 网络性能工具

![网络性能指标](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-09.png)

![网络性能工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/08-10.png)



**当分析性能问题时，大的来说，主要有这么两个步骤：**

**第一步，从性能瓶颈出发，根据系统和应用程序的运行原理，确认待分析的性能指标。**

**第二步，根据这些图表，选出最合适的性能工具，然后了解并使用工具，从而更快观测到需要的性能数据。**