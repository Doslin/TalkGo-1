# 第 7阶段课程笔记

## 43 | 套路篇：网络性能优化的几个思路（上）

### 确定优化目标

为了更客观合理地评估优化效果，我们首先应该明确优化的标准，即要对系统和应用程序进行基准测试，得到网络协议栈各层的基准性能。

在进行基准测试时，我们就可以按照协议栈的每一层来测试。由于底层是其上方各层的基础，底层性能也就决定了高层性能。

首先是**网络接口层和网络层**，它们主要负责网络包的封装、寻址、路由，以及发送和接收。每秒可处理的网络包数 PPS，就是它们最重要的性能指标（特别是在小包的情况下）。你可以用内核自带的发包工具 **pktgen** ，来测试 PPS 的性能。

再向上到**传输层的 TCP 和 UDP**，它们主要负责网络传输。对它们而言，吞吐量（BPS）、连接数以及延迟，就是最重要的性能指标。你可以用 **iperf 或 netperf** ，来测试传输层的性能。注意，网络包的大小。

最后，再往上到了**应用层**，最需要关注的是吞吐量（BPS）、每秒请求数以及延迟等指标。你可以用 **wrk、ab** 等工具，来测试应用程序的性能。

不过，这里要注意的是，**测试场景要尽量模拟生产环境，这样的测试才更有价值**。比如，你可以到生产环境中，录制实际的请求情况，再到测试中回放。



### 网络性能工具

![根据指标找工具](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/07-01.png)



![根据工具查指标](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/07-02.png)



### 网络性能优化

从应用程序、套接字、传输层、网络层以及链路层等几个角度，分别来看网络性能优化的基本思路。

#### 应用程序

**从网络 I/O 的角度来说，主要有下面两种优化思路。**

第一种是最常用的 I/O 多路复用技术 epoll，主要用来取代 select 和 poll。

第二种是使用异步 I/O（Asynchronous I/O，AIO）。

**从进程的工作模型来说，也有两种不同的模型用来优化。**

第一种，主进程 + 多个 worker 子进程。

第二种，监听到相同端口的多进程模型。

除了网络 I/O 和进程的工作模型外，**应用层的网络协议优化**：

1. 使用长连接取代短连接；
2. 使用内存等方式，来缓存不常变化的数据
3. 使用 Protocol Buffer 等序列化的方式，压缩网络 I/O 的数据量，可以提高应用程序的吞吐。
4. 使用 DNS 缓存、预取、HTTPDNS 等方式，减少 DNS 解析的延迟，也可以提升网络 I/O 的整体速度。

#### 套接字

![套接字内核选项](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/07-03.png)

套接字接口还提供了一些配置选项，用来修改网络连接的行为：

1. 为 TCP 连接设置 TCP_NODELAY 后，就可以禁用 Nagle 算法；
2. 为 TCP 连接开启 TCP_CORK 后，可以让小包聚合成大包后再发送（注意会阻塞小包的发送）；
3. 使用 SO_SNDBUF 和 SO_RCVBUF ，可以分别调整套接字发送缓冲区和接收缓冲区的大小。



## 44 | 套路篇：网络性能优化的几个思路（下）

### 传输层

#### TCP

第一类，在请求数比较大的场景下，你可能会看到大量处于 TIME_WAIT 状态的连接，它们会占用大量内存和端口资源。

第二类，为了缓解 SYN FLOOD 等，利用 TCP 协议特点进行攻击而引发的性能问题

第三类，在长连接的场景中，通常使用 Keepalive 来检测 TCP 连接的状态，以便对端连接断开后，可以自动回收。



![tCP优化](https://github.com/hwangyungping/TalkGo/blob/master/TalkGo读书会--第一期/PIC/07-03.png)



#### UDP

UDP 提供了面向数据报的网络协议，它不需要网络连接，也不提供可靠性保障。

1. 增大套接字缓冲区大小以及 UDP 缓冲区范围；
2. 增大本地端口号的范围；
3. 根据 MTU 大小，调整 UDP 数据包的大小，减少或者避免分片的发生。



### 网络层

网络层，负责网络包的封装、寻址和路由，包括 IP、ICMP 等常见协议。在网络层，最主要的优化，其实就是对路由、 IP 分片以及 ICMP 等进行调优。

1. **从路由和转发的角度出发，调整相关内核选项：net.ipv4.ip_forward 、 net.ipv4.ip_default_ttl、net.ipv4.conf.eth0.rp_filter **
2. **从分片的角度出发，最主要的是调整 MTU（Maximum Transmission Unit）的大小。**
3. **从 ICMP 的角度出发，为了避免 ICMP 主机探测、ICMP Flood 等各种网络问题，你可以通过内核选项，来限制 ICMP 的行为**



### 链路层

链路层负责网络包在物理网络中的传输，比如 MAC 寻址、错误侦测以及通过网卡传输网络帧等



**为网卡硬中断配置 CPU 亲和性（smp_affinity），或者开启 irqbalance 服务。**

**开启 RPS（Receive Packet Steering）和 RFS（Receive Flow Steering），**



### 总结

1. **在应用程序中，主要是优化 I/O 模型、工作模型以及应用层的网络协议；**
2. **在套接字层中，主要是优化套接字的缓冲区大小；**
3. **在传输层中，主要是优化 TCP 和 UDP 协议；**
4. **在网络层中，主要是优化路由、转发、分片以及 ICMP 协议；**
5. **在链路层中，主要是优化网络包的收发、网络功能卸载以及网卡选项。**



## 45 | 答疑（五）：网络收发过程中，缓冲区位置在哪里？



**Linux 网络的收发流程**

这个流程涉及到了多个队列和缓冲区，包括：

网卡收发网络包时，通过 DMA 方式交互的环形缓冲区；

网卡中断处理程序为网络帧分配的，内核数据结构 sk_buff 缓冲区；

应用程序通过套接字接口，与网络协议栈交互时的套接字缓冲区。































倪朋飞老师微信号：feisky